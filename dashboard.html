<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptsBinsAuth - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { min-height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); padding: 20px; }
        .header { max-width: 1100px; margin: 0 auto 30px; display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: rgba(30,30,50,0.95); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .header h1 { color: #fff; font-size: 24px; }
        .header h1 span { color: #8b5cf6; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-email { color: #888; font-size: 14px; }
        .btn-logout { padding: 10px 20px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #f87171; font-size: 14px; cursor: pointer; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: rgba(30,30,50,0.95); border-radius: 16px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .card h2 { color: #fff; font-size: 18px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .panel-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .panel-name { color: #8b5cf6; font-size: 18px; font-weight: 600; }
        .panel-meta { color: #888; font-size: 13px; margin-bottom: 15px; }
        .panel-meta span { margin-right: 15px; }
        .library-id { background: rgba(139,92,246,0.2); color: #a78bfa; padding: 8px 12px; border-radius: 8px; font-family: monospace; font-size: 14px; display: inline-block; margin-bottom: 15px; }
        .btn { padding: 10px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; border: 1px solid; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6, #a855f7); border: none; color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(139,92,246,0.4); }
        .btn-secondary { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); color: #a78bfa; }
        .btn-danger { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #f87171; }
        .btn-warning { background: rgba(251,191,36,0.2); border-color: rgba(251,191,36,0.3); color: #fbbf24; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-input { flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #8b5cf6; }
        .form-select { padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 14px; min-width: 120px; }
        .form-select option { background: #1a1a2e; }
        .message { padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 14px; text-align: center; }
        .message.success { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.3); color: #4ade80; }
        .message.error { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
        .keys-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .key-item { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .key-value { font-family: monospace; color: #8b5cf6; font-size: 13px; }
        .key-meta { color: #888; font-size: 12px; }
        .key-status { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .key-status.active { background: rgba(34,197,94,0.2); color: #4ade80; }
        .key-status.expired { background: rgba(239,68,68,0.2); color: #f87171; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: rgba(30,30,50,0.98); border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { color: #fff; font-size: 20px; }
        .modal-close { background: none; border: none; color: #f87171; font-size: 24px; cursor: pointer; }
        .copy-btn { background: none; border: none; color: #8b5cf6; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Scripts<span>Bins</span>Auth</h1>
        <div class="user-info">
            <span class="user-email" id="userEmail">Loading...</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <!-- Criar Painel -->
        <div class="card">
            <h2>üìÅ Create New Panel</h2>
            <div class="form-row">
                <input type="text" class="form-input" id="panelName" placeholder="Panel name (e.g., Auto Rotas)" maxlength="30">
                <button class="btn btn-primary" onclick="createPanel()">Create Panel</button>
            </div>
            <div id="createMessage" class="message" style="display:none;"></div>
        </div>

        <!-- Lista de Pain√©is -->
        <div class="card">
            <h2>üìã Your Panels</h2>
            <div class="grid" id="panelsList">
                <div class="empty-state">
                    <p>You don't have any panels yet</p>
                    <p style="font-size:13px;margin-top:5px;">Create your first panel above</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Keys -->
    <div class="modal" id="keysModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Panel Keys</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-row">
                <select class="form-select" id="keyDuration">
                    <option value="86400">1 Day</option>
                    <option value="604800">7 Days</option>
                    <option value="2592000">30 Days</option>
                    <option value="7776000">90 Days</option>
                    <option value="31536000">1 Year</option>
                    <option value="315360000">Lifetime</option>
                </select>
                <button class="btn btn-primary" onclick="generateKey()">üîë Generate Key</button>
            </div>
            <div id="keyMessage" class="message" style="display:none;"></div>
            <div class="keys-list" id="modalKeysList"></div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';
        document.getElementById('userEmail').textContent = localStorage.getItem('userEmail') || 'User';
        
        let currentPanelId = null;
        let currentPanelName = '';
        loadPanels();

        async function loadPanels() {
            try {
                const response = await fetch('/api/panels/list', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                if (response.ok && data.panels) {
                    renderPanels(data.panels);
                }
            } catch (error) {
                console.error('Error loading panels');
            }
        }

        function renderPanels(panels) {
            const container = document.getElementById('panelsList');
            if (panels.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>You don\\'t have any panels yet</p></div>';
                return;
            }
            container.innerHTML = panels.map(p => `
                <div class="panel-item">
                    <div class="panel-header">
                        <span class="panel-name">${p.name}</span>
                        <span class="key-status active">${p.keyCount} keys</span>
                    </div>
                    <div class="library-id">
                        Library ID: ${p.libraryId}
                        <button class="copy-btn" onclick="copyText('${p.libraryId}')">üìã</button>
                    </div>
                    <div class="panel-meta">
                        <span>üìÖ ${p.createdAt}</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="openKeys('${p.libraryId}', '${p.name}')">üîë Keys</button>
                        <button class="btn btn-secondary" onclick="copyScript('${p.libraryId}')">üìú Script</button>
                        <button class="btn btn-danger" onclick="deletePanel('${p.libraryId}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function createPanel() {
            const name = document.getElementById('panelName').value.trim();
            const msg = document.getElementById('createMessage');
            
            if (!name) {
                showMsg(msg, 'Please enter a panel name', 'error');
                return;
            }

            try {
                const response = await fetch('/api/panels/create', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await response.json();
                if (response.ok) {
                    showMsg(msg, `‚úÖ Panel "${data.panel.name}" created! Library ID: ${data.panel.libraryId}`, 'success');
                    document.getElementById('panelName').value = '';
                    loadPanels();
                } else {
                    showMsg(msg, data.error || 'Error creating panel', 'error');
                }
            } catch (error) {
                showMsg(msg, 'Connection error', 'error');
            }
        }

        async function deletePanel(libraryId) {
            if (!confirm('Delete this panel and ALL its keys? This cannot be undone!')) return;
            try {
                const response = await fetch('/api/panels/delete', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ libraryId })
                });
                if (response.ok) {
                    loadPanels();
                }
            } catch (error) {
                alert('Error deleting panel');
            }
        }

        async function openKeys(panelId, panelName) {
            currentPanelId = panelId;
            currentPanelName = panelName;
            document.getElementById('modalTitle').textContent = `üîë ${panelName} Keys`;
            document.getElementById('keysModal').classList.add('active');
            loadKeys();
        }

        function closeModal() {
            document.getElementById('keysModal').classList.remove('active');
            currentPanelId = null;
        }

        async function loadKeys() {
            try {
                const response = await fetch(`/api/keys/list?panelId=${currentPanelId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                renderKeys(data.keys || []);
            } catch (error) {
                console.error('Error loading keys');
            }
        }

        function renderKeys(keys) {
            const container = document.getElementById('modalKeysList');
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No keys yet</p></div>';
                return;
            }
            container.innerHTML = keys.map(k => `
                <div class="key-item">
                    <div>
                        <div class="key-value">${k.key}</div>
                        <div class="key-meta">‚è∞ ${k.expiresIn} | üñ•Ô∏è HWID: ${k.hwid ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="copyText('${k.key}')" style="padding:6px 12px;">üìã</button>
                        <button class="btn btn-warning" onclick="resetHWID('${k.key}')" style="padding:6px 12px;">üîÑ</button>
                        <button class="btn btn-danger" onclick="deleteKey('${k.key}')" style="padding:6px 12px;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function generateKey() {
            const duration = document.getElementById('keyDuration').value;
            const msg = document.getElementById('keyMessage');
            try {
                const response = await fetch('/api/keys/generate', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: parseInt(duration), panelId: currentPanelId })
                });
                const data = await response.json();
                if (response.ok) {
                    showMsg(msg, `‚úÖ Key: ${data.key}`, 'success');
                    loadKeys();
                    loadPanels();
                } else {
                    showMsg(msg, data.error, 'error');
                }
            } catch (error) {
                showMsg(msg, 'Connection error', 'error');
            }
        }

        async function resetHWID(key) {
            if (!confirm('Reset HWID?')) return;
            try {
                await fetch('/api/keys/reset-hwid', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                loadKeys();
            } catch (error) {}
        }

        async function deleteKey(key) {
            if (!confirm('Delete this key?')) return;
            try {
                await fetch('/api/keys/delete', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                loadKeys();
                loadPanels();
            } catch (error) {}
        }

        function copyText(text) {
            navigator.clipboard.writeText(text);
            alert('Copied!');
        }

        function copyScript(libraryId) {
            const script = `loadstring(game:HttpGet("${window.location.origin}/api/lib/${libraryId}"))()`;
            navigator.clipboard.writeText(script);
            alert('Script copied!\\n\\n' + script);
        }

        function showMsg(el, text, type) {
            el.className = 'message ' + type;
            el.textContent = text;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
